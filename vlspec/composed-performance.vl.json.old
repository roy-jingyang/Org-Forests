{
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "description": "Composed multi-facet view",

  "config": {
    "axisX": {
      "labelAngle": -45
    }
  },

  "transform": [
    {
      "timeUnit": "yearweek",
      "field": "date",
      "as": "date_week"
    },
    {
      "timeUnit": "yearweek",
      "field": "case_start",
      "as": "case_start_week"
    },
    {
      "timeUnit": "yearweek",
      "field": "case_end",
      "as": "case_end_week"
    }
  ],

  "columns": 2,
  "resolve": {"legend": {"color": "independent"}},
  "concat": [
    {
      "title": {
        "text": "group workload: #events (overview)",
        "subtitle": "workload: assignments, stacked area chart"
      },

      "width": 360,
      "height": 100,

      "mark": "area",

      "transform": [{
        "aggregate": [{
            "op": "count",
            "as": "group_assignment"
        }],
        "groupby": ["date", "group"]
      }],

      "selection": {
        "sel_date_interval": {
          "type": "interval", 
          "encodings": ["x"],
          "empty": "all"
        }
      },

      "encoding": {
        "x": {
          "timeUnit": "yearquarter",
          "field": "date"
        },
        "y": {
          "aggregate": "sum",
          "field": "group_assignment",
          "title": "#events"
        },
        "color": {
          "field": "group",
          "type": "nominal"
        }
      }

    },

    {
      "title": "group workload: #events (detailed view)",

      "width": 960,
      "height": 200,

      "transform": [
        {
          "aggregate": [{
              "op": "count",
              "as": "group_assignment"
          }],
          "groupby": ["date_week", "group"]
        }
      ],

      "encoding": {
        "x": {
          "field": "date_week",
          "type": "temporal",
          "scale": {"domain": {"selection": "sel_date_interval"}}
        }
      },

      "layer": [
        {
          "mark": {
            "type": "area",
            "point": true
          },
          "selection": {
            "sel_group": {
              "type": "multi", 
              "fields": ["group"], 
              "bind": "legend"
            }
          },
          "encoding": {
            "y": {
              "aggregate": "sum",
              "field": "group_assignment",
              "title": "# events",
              "type": "quantitative"
            },
            "color": {
              "field": "group",
              "type": "nominal"
            },
            "opacity": {
              "condition": {"selection": "sel_group", "value": 1},
              "value": 0.2
            }
          }
        },

        {
          "mark": "rule",
          "transform": [{"pivot": "group", "value": "group_assignment", "groupby": ["date_week"]}],
          "encoding": {
            "opacity": {
              "condition": {"value": 0.5, "selection": "sel_date"},
              "value": 0
            },
            "tooltip": [
              {
                "field": "date_week",
                "type": "temporal",
                "format": "%W",
                "title": "Week"
              },
              {
                "field": "date_week",
                "type": "temporal",
                "format": "%Y-%m-%d (%a)",
                "title": "Week start"
              }
            ]
          },
          "selection": {
            "sel_date": {
              "type": "multi",
              "fields": ["date_week"],
              "nearest": true,
              "on": "click",
              "empty": "none"
            }
          }
        },

        {
          "mark": {"type": "text", "align": "center"},
          "encoding": {
            "text": {
              "condition": {
                "selection": "sel_date",
                "field": "date_week", 
                "type": "temporal",
                "format": "Week-%W, %Y"
              }
            },
            "y": {"value": 10}
          }
        }
      ]
    },
    {
      "title": {
        "text": "group attendance: #resources (overview)",
        "subtitle": "participation: attendance, stacked area chart"
      },

      "width": 360,
      "height": 100,

      "mark": "area",

      "selection": {
        "sel_date_interval": {
          "type": "interval", 
          "encodings": ["x"],
          "empty": "all"
        }
      },

      "encoding": {
        "x": {
          "timeUnit": "yearquarter",
          "field": "date"
        },
        "y": {
          "aggregate": "distinct",
          "field": "resource",
          "title": "#resources"
        },
        "color": {
          "field": "group",
          "type": "nominal"
        }
      }

    },

    {
      "title": "group attendance: #resources (detailed view)",

      "width": 960,
      "height": 200,

      "transform": [
        {
          "aggregate": [{
              "op": "distinct",
              "field": "resource",
              "as": "group_attendance"
          }],
          "groupby": ["date_week", "group"]
        }
      ],

      "encoding": {
        "x": {
          "field": "date_week",
          "type": "temporal",
          "scale": {"domain": {"selection": "sel_date_interval"}}
        }
      },

      "layer": [
        {
          "mark": {
            "type": "area",
            "point": true
          },
          "selection": {
            "sel_group": {
              "type": "multi", 
              "fields": ["group"], 
              "bind": "legend"
            }
          },
          "encoding": {
            "y": {
              "aggregate": "sum",
              "field": "group_attendance",
              "title": "#resources",
              "type": "quantitative"
            },
            "color": {
              "field": "group",
              "type": "nominal"
            },
            "opacity": {
              "condition": {"selection": "sel_group", "value": 1},
              "value": 0.2
            }
          }
        },

        {
          "mark": "rule",
          "transform": [{"pivot": "group", "value": "group_attendance", "groupby": ["date_week"]}],
          "encoding": {
            "opacity": {
              "condition": {"value": 0.5, "selection": "sel_date"},
              "value": 0
            },
            "tooltip": [
              {
                "field": "date_week",
                "type": "temporal",
                "format": "%W",
                "title": "Week"
              },
              {
                "field": "date_week",
                "type": "temporal",
                "format": "%Y-%m-%d (%a)",
                "title": "Week start"
              }
            ]
          },
          "selection": {
            "sel_date": {
              "type": "multi",
              "fields": ["date_week"],
              "nearest": true,
              "on": "click",
              "empty": "none"
            }
          }
        },

        {
          "mark": {"type": "text", "align": "center"},
          "encoding": {
            "text": {
              "condition": {
                "selection": "sel_date",
                "field": "date_week", 
                "type": "temporal",
                "format": "Week-%W, %Y"
              }
            },
            "y": {"value": 10}
          }
        }
      ]
    },

    {
      "title": {
        "text": "case throughput (overview)",
        "subtitle": "produtivity: throughput, stacked area chart"
      },

      "width": 360,
      "height": 100,

      "mark": "area",

      "transform": [{
        "aggregate": [{
          "op": "distinct",
          "field": "case_id",
          "as": "group_cases_ended"
        }],
        "groupby": ["case_end", "group"]
      }],

      "selection": {
        "sel_date_interval": {
          "type": "interval", 
          "encodings": ["x"],
          "empty": "all"
        }
      },

      "encoding": {
        "x": {
          "timeUnit": "yearquarter",
          "field": "case_end"
        },
        "y": {
          "aggregate": "sum",
          "field": "group_cases_ended",
          "title": "#cases started"
        },
        "color": {
          "field": "group",
          "type": "nominal"
        }
      }

    },

    {
      "title": "case throughput (detailed view)",

      "width": 960,
      "height": 200,

      "transform": [
        {
          "aggregate": [{
            "op": "distinct",
            "field": "case_id",
            "as": "group_cases_completed"
          }],
          "groupby": ["case_end_week", "group"]
        }
      ],

      "encoding": {
        "x": {
          "field": "case_end_week",
          "type": "temporal",
          "scale": {"domain": {"selection": "sel_date_interval"}}
        }
      },

      "layer": [
        {
          "mark": {
            "type": "area",
            "point": true
          },
          "selection": {
            "sel_group": {
              "type": "multi", 
              "fields": ["group"], 
              "bind": "legend"
            }
          },
          "encoding": {
            "y": {
              "aggregate": "sum",
              "field": "group_cases_completed",
              "title": "#cases completed",
              "type": "quantitative"
            },
            "color": {
              "field": "group",
              "type": "nominal"
            },
            "opacity": {
              "condition": {"selection": "sel_group", "value": 1},
              "value": 0.2
            }
          }
        },
        {
          "mark": "rule",
          "transform": [{"pivot": "group", "value": "group_cases_completed", "groupby": ["case_end_week"]}],
          "encoding": {
            "opacity": {
              "condition": {"value": 0.5, "selection": "sel_date"},
              "value": 0
            },
            "tooltip": [
              {
                "field": "case_end_week",
                "type": "temporal",
                "format": "%W",
                "title": "Week"
              },
              {
                "field": "case_end_week",
                "type": "temporal",
                "format": "%Y-%m-%d (%a)",
                "title": "Week start"
              }
            ]
          },
          "selection": {
            "sel_date": {
              "type": "multi",
              "fields": ["case_end_week"],
              "nearest": true,
              "on": "click",
              "empty": "none"
            }
          }
        },

        {
          "mark": {"type": "text", "align": "center"},
          "encoding": {
            "text": {
              "condition": {
                "selection": "sel_date",
                "field": "case_end_week", 
                "type": "temporal",
                "format": "Week-%W, %Y"
              }
            },
            "y": {"value": 10}
          }
        }
      ]
    },

    {
      "title": {
        "text": "case cycle time (overview)",
        "subtitle": "productivity: throughput (stacked area chart)"
      },

      "width": 360,
      "height": 100,

      "mark": "line",

      "selection": {
        "sel_date_interval": {
          "type": "interval", 
          "encodings": ["x"],
          "empty": "all"
        }
      },

      "encoding": {
        "x": {
          "timeUnit": "yearquarter",
          "field": "case_end"
        },
        "y": {
          "aggregate": "average",
          "field": "case_duration_days",
          "title": "throughput (days)"
        },
        "color": {
          "field": "group",
          "type": "nominal"
        }
      }

    },

    {
      "title": "case cycle time (detailed view)",

      "width": 960,
      "height": 200,

      "transform": [
        {
          "aggregate": [{
            "op": "average",
            "field": "case_duration_days",
            "as": "group_throughput"
          }],
          "groupby": ["case_end_week", "group"]
        }
      ],

      "encoding": {
        "x": {
          "field": "case_end_week",
          "type": "temporal",
          "scale": {"domain": {"selection": "sel_date_interval"}}
        }
      },

      "layer": [
        {
          "mark": {
            "type": "line",
            "point": true
          },
          "selection": {
            "sel_group": {
              "type": "multi", 
              "fields": ["group"], 
              "bind": "legend"
            }
          },
          "encoding": {
            "y": {
              "aggregate": "average",
              "field": "group_throughput",
              "title": "throughput (days)",
              "type": "quantitative"
            },
            "color": {
              "field": "group",
              "type": "nominal"
            },
            "opacity": {
              "condition": {"selection": "sel_group", "value": 1},
              "value": 0.2
            }
          }
        },
        {
          "mark": "rule",
          "transform": [{"pivot": "group", "value": "group_throughput", "groupby": ["case_end_week"]}],
          "encoding": {
            "opacity": {
              "condition": {"value": 0.5, "selection": "sel_date"},
              "value": 0
            },
            "tooltip": [
              {
                "field": "case_end_week",
                "type": "temporal",
                "format": "%W",
                "title": "Week"
              },
              {
                "field": "case_end_week",
                "type": "temporal",
                "format": "%Y-%m-%d (%a)",
                "title": "Week start"
              }
            ]
          },
          "selection": {
            "sel_date": {
              "type": "multi",
              "fields": ["case_end_week"],
              "nearest": true,
              "on": "click",
              "empty": "none"
            }
          }
        },

        {
          "mark": {"type": "text", "align": "center"},
          "encoding": {
            "text": {
              "condition": {
                "selection": "sel_date",
                "field": "case_end_week", 
                "type": "temporal",
                "format": "Week-%W, %Y"
              }
            },
            "y": {"value": 10}
          }
        }
      ]
    }


  ]
}